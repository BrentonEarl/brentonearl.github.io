<!DOCTYPE HTML>
<html lang="en">
	<head>       
		<meta charset=utf-8>
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
		<title>Exit Status One - Block Port Scans and Brute Force Attacks</title>
		<meta name="author" content="Brent Earl" />
		
		<meta name="description" content="Learn to block port scans and brute force attacks in Linux" />
		
		
		<meta name="keywords" content="security" />
		
		<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
		<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">
		<link rel="stylesheet" herf="/css/styles.css" type="text/css">
		<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
		<!--[if lt IE 9]>
		<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
		<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
		<![endif]-->
	</head>
	<body>
		<nav class="navbar navbar-inverse navbar-static-top" role="navigation">
			<div class="container">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<p class="navbar-brand" href="#">Menu</p>
				</div>
				<div class="navbar-collapse collapse">
					<ul class="nav navbar-nav">
						<li><a href="/" title=" Index">Home</a></li>
						
						
						
						<li><a href="/about.html" title="About the Author">About</a></li>
						
						
						
						<li><a href="/archive.html" title="Site Archives">Archives</a></li>
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						<li><a href="/rss.xml" title="RSS News Feed">News Feed</a></li>
						
						
						
						
					</ul>
				</div>
			</div>
		</nav>
		<header>
			<div class="container">
				<div class="page-header">
					<h1>Exit Status One</h1>
					<small>while : ; do echo 'Tinker, explore, hack, learn...' ; sleep 28800 ; clear ; done</small>
				</div>
			</div>
		</header>
	
		<div class="container">
					<div class="row">
				<div class="col-sm-8">
						<article>
						<h4>Block Port Scans and Brute Force Attacks</h4>
						<p>
						08-14-2013 by <a href="https://twitter.com/BrentonLeeEarl">Brent Earl</a>
						</p>
						

						<p>
						Category <a href="/categories/security/">security</a>
						</p>
						<p>It is a guarantee that any internet facing desktop or server will be probed by attackers.  This discussion is geared toward Linux servers, but the same techniques can be applied to any other Linux installed device.  Assuming your server is accessible on public networks and it is running network services, it is important that you take the appropriate security precautions.  Port scans <strong>will</strong> bombard your network card and brute force attempts will plague your log in services.  Sometimes a strong password just is not enough.  After all, brute force attempts and port scans do after use bandwidth and do cause your network to slow down.</p>

<p>This article is follow up to a previous post:  <a href="http://exitstatusone.com/medusa-log-in-auditor/">Medusa - Parallel Network Login Auditor</a> where the average brute force attack is demonstrated.</p>

<p>I will outline a basic set up which includes Iptables, Psad and Fail2ban.</p>

<ul>
<li><a href="http://en.wikipedia.org/wiki/Iptables">Iptables - Linux kernel firewall</a></li>
<li><a href="http://cipherdyne.org/psad/">Psad - Intrusion Detection and Log Analysis with iptables</a></li>
<li><a href="http://www.fail2ban.org/wiki/index.php/Main_Page">Fail2ban - Intrusion Prevention Framework</a></li>
</ul>


<h4>Iptables</h4>

<p>In order for any of this to work effectively, it is important to have some sort of firewall rules set up so that you can log dropped packets and control what ports should be open and closed.  At the very least you should have something similar to the following:</p>

<ul>
<li>Assuming the only service you are running is SSH</li>
</ul>


<div class="highlight"><pre><code class="bash"><span class="c"># Allow ssh</span>
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

<span class="c"># Allow icmp</span>
iptables -A INPUT -p icmp -j ACCEPT

<span class="c"># Allow local</span>
iptables -A INPUT -s 127.0.0.1 -j ACCEPT

<span class="c"># Allow connections already made</span>
iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -i eth0 -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT

<span class="c"># Enable Logging of Input and Forwarding</span>
iptables -A INPUT -m limit --limit 5/min -j LOG --log-prefix <span class="s2">&quot;DENIED: &quot;</span> --log-level 7
iptables -A FORWARD -m limit --limit 5/min -j LOG --log-prefix <span class="s2">&quot;DENIED: &quot;</span> --log-level 7

<span class="c"># Drop all other traffic</span>
iptables -A INPUT -j DROP
iptables -A FORWARD -j DROP
</code></pre></div>


<h4>Intrusion Detection and Log Analysis</h4>

<p><a href="http://cipherdyne.org/psad/">Psad</a> is a great piece of software for a single server, such as a colo, or a home server.  It may be considered a great tool for companies with a single server as well.  I am sure the Psad guys would disagree, but I do not recommend using Psad for large scale operations.  For that I would recommened <a href="http://www.snort.org/">Snort</a>.  Moving forward.</p>

<p>Psad scans the log files on the server and looks for dropped packets.  If the dropped packets fit the pattern of a port scan, the packets are logged, and if configured to, blocked by source IP address.</p>

<p>A default installation of Psad will log port scans and email the system administrator.  What I would like to discuss is how to set up Psad to automatically block port scans as well.  The following settings are located in the psad.conf file.  I am running Debian, so it is located at /etc/psad/psad.conf, it may be different for other Linux distributions.</p>

<ul>
<li>These are the settings you need to change in order to have email notifications, logging and automatic iptables integration.</li>
</ul>


<div class="highlight"><pre><code class="bash">EMAIL_ADDRESSES             your@email.com<span class="p">;</span>
EMAIL_ALERT_DANGER_LEVEL    1<span class="p">;</span>

FW_MSG_SEARCH               DROP<span class="p">;</span>

DANGER_LEVEL1               5<span class="p">;</span>    <span class="c">### Number of packets.</span>
DANGER_LEVEL2               15<span class="p">;</span>
DANGER_LEVEL3               150<span class="p">;</span>
DANGER_LEVEL4               1500<span class="p">;</span>
DANGER_LEVEL5               10000<span class="p">;</span>

ENABLE_AUTO_IDS             Y<span class="p">;</span>
AUTO_IDS_DANGER_LEVEL       2<span class="p">;</span> <span class="c"># Or your desired danger level</span>
IPTABLES_BLOCK_METHOD       Y<span class="p">;</span>
</code></pre></div>


<p>The rest of the options in the psad.conf should be left at defaults unless you have some sort of specific configuration.</p>

<h4>Intrusion Prevention</h4>

<p><a href="http://www.fail2ban.org/wiki/index.php/Main_Page">Fail2ban</a> is an excellent piece of software for blocking brute force attempts.  I highly recommend that it is installed on every linux server running SSH.  It is also very useful in blocking brute force attempts on HTTP forms as well as FTP credentials.  Fail2ban will monitor just about any service that allows network authentication.  There are far too many services out there, so I will show a basic set up for SSH.</p>

<ul>
<li>This is a default rule in the jail.conf configuration file</li>
<li>The port reflects the port I use for SSH</li>
<li>The maxretry designates that any failed log in attempts should be banned</li>
<li>This is set up like this because I use public/private key authentication on my server</li>
</ul>


<div class="highlight"><pre><code class="bash"><span class="o">[</span>ssh<span class="o">]</span>

<span class="nv">enabled</span> <span class="o">=</span> <span class="nb">true</span>
<span class="nv">port</span>    <span class="o">=</span> 3000
<span class="nv">filter</span>  <span class="o">=</span> sshd
<span class="nv">logpath</span>  <span class="o">=</span> /var/log/auth.log
<span class="nv">maxretry</span> <span class="o">=</span> 1
</code></pre></div>


<p>Take it one step further and ban all DDoS attempts on SSH.  Again I chose to ban any activity that had more than one connection attempt.</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>ssh-ddos<span class="o">]</span>

<span class="nv">enabled</span> <span class="o">=</span> <span class="nb">true</span>
<span class="nv">port</span>    <span class="o">=</span> ssh
<span class="nv">filter</span>  <span class="o">=</span> sshd-ddos
<span class="nv">logpath</span>  <span class="o">=</span> /var/log/auth.log
<span class="nv">maxretry</span> <span class="o">=</span> 1
</code></pre></div>


<h4>Password Strength</h4>

<p>Even with all of the above precautions in place, a timed, long term attack can still manage to break into your system if you have a weak password.  It will take a very long time, assuming you have the same set up as I do.  It is unlikely you will choose to ban all traffic with more than one failed log in attempt though.  My configuration is based on the fact that I am the only person that should be logging into the server and that I am using key authentication.  If I was using password authentication, I would probably change the maxretry to 6 attempts.  6 attempts provides an attacker with greater chance of successful intrusion.  Assuming the attacker has automated his or her attack, the typical configuration of Fail2ban will ban the source IP address for one hour.  This allows for 144 failed log in attempts within 24 hours.</p>

<p>Very often, weak passwords may only take a few attempts to crack if the attacker has some sort of intel about the target machine.  Even without any information about the target machine, 144 attempts might be enough to crack an account in one day.  It is likely that in a weeks time (1008 attempts) a weak password will not be compromised.</p>

<p>I use <a href="http://linux.die.net/man/1/apg">APG - Automated Password Generator</a> to generate my passwords.  Here is an example of agp in action:</p>

<ul>
<li>Using the old password of 'catfood'</li>
</ul>


<div class="highlight"><pre><code class="bash">root@localhost~# apg

Please enter some random data <span class="o">(</span>only first 16 are significant<span class="o">)</span>
<span class="o">(</span>eg. your old password<span class="o">)</span>:&gt;
EfyurbAkUj4 <span class="o">(</span>Ef-yurb-Ak-Uj-FOUR<span class="o">)</span>
ofdynErvEif5 <span class="o">(</span>of-dyn-Erv-Eif-FIVE<span class="o">)</span>
UrtUttetEk8 <span class="o">(</span>Urt-Utt-et-Ek-EIGHT<span class="o">)</span>
JocNadEnVam1 <span class="o">(</span>Joc-Nad-En-Vam-ONE<span class="o">)</span>
Ur6Oboykyet <span class="o">(</span>Ur-SIX-Ob-oyk-yet<span class="o">)</span>
CedsidIn3 <span class="o">(</span>Ceds-id-In-THREE<span class="o">)</span>
</code></pre></div>


<hr />

<h4>Summary</h4>

<p>Each day countless servers are hacked due to weak passwords, poor encryption and outdated software.  While the above will not prevent zero day exploits, it will stop service detection and enumeration.  It will keep your server credentials safe.  Strong passwords and password rotations are important.</p>

					</article>
				</div>
				<div class="col-sm-4">
				<div class="list-group">
	<h4 class="list-group-item">Related Posts</h4>
	
		
			
				
					<a class="list-group-item" href="/the-fuzz/" title="The Fuzz">The Fuzz</a>
				
			
		
	
		
			
		
	
		
			
				
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
				
					<a class="list-group-item" href="/medusa-log-in-auditor/" title="Medusa - Parallel Network Login Auditor">Medusa - Parallel Network Login Auditor</a>
				
			
		
	
		
			
				
					<a class="list-group-item" href="/crunch-word-list-generator/" title="Crunch Word List Generator">Crunch Word List Generator</a>
				
			
		
	
		
			
		
	
		
			
		
	
		
			
				
					<a class="list-group-item" href="/anonymity/" title="Anonymity">Anonymity</a>
				
			
		
	
		
			
		
	
		
			
		
	
		
			
				
					<a class="list-group-item" href="/proxy-chains-anonymous-web-browsing/" title="Proxy Chains – Anonymous Web Browsing">Proxy Chains – Anonymous Web Browsing</a>
				
			
		
	
		
			
		
	
		
			
		
	
		
			
				
					<a class="list-group-item" href="/penetration-testing-nessus-metasploit/" title="Penetration Testing with Metasploit 4 and Nessus 5.2">Penetration Testing with Metasploit 4 and Nessus 5.2</a>
				
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
</div>


				</div>
			</div>
			<br /><br />
<p><strong>If you feel the information here is outdated or incorrect, you can submit a <a href="https://github.com/BrentonEarl/brentonearl.github.io/edit/source/_posts/2013-08-14-block-port-scan-brute-force.markdown">Pull Request on Github!</a></strong></p>

			
<div class="row">
	<div class="col-sm-8">
		<div id="disqus_thread" style="padding:1%;"></div>
		<script type="text/javascript">
		var disqus_shortname = 'exitstatusone';
		(function() {
		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		})();
		</script>
		<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
		<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	</div>
</div>



		</div>
	
		<footer>
			<div class="container">
				<div class="row">
					<div class="col-sm-8">
						<p class="footer">
						&copy; 2014 Brent Earl. Powered by <a href="http://jekyllrb.com/" title="Jekyllrb">Jekyll</a>.
						</p>
					</div>
				</div>
			</div>
		</footer>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
		<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
	</body>
</html>
